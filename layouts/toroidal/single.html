{{/*
  Hugo sorts pages by weight in reverse,
  so lower weights are "next" and higher weights are "prev"

  For this reason, we invert our logic for the webring linking.
*/}}
{{- $vars := newScratch -}}
{{/* Grab the list of member pages; these are already sorted by weight */}}
{{- $toroidalPages := where .Site.Pages "Section" "toroidal"}}
{{- $toroidalPages = where $toroidalPages "Params.homepage" "!=" nil -}}
{{/* Set the name string for the menu label*/}}
{{- with .Site.Params.Toroidal.WebringName -}}
  {{- $vars.Set "webringName" (printf "%s " .) -}}
{{- else -}}
  {{- $vars.Set "webringName" "" -}}
{{- end -}}
{{/*
  Get the previous page ("NextInSection" according to Hugo;
  if none, get the *last* page in the section.
*/}}
{{- with .NextInSection -}}
  {{- $vars.Set "previous" .Params.homepage -}}
{{- else -}}
  {{- range (last 1 $toroidalPages) -}}
    {{- $vars.Set "previous" .Params.homepage -}}
  {{- end -}}
{{- end -}}
{{/*
  Get the next page ("PrevInSection" according to Hugo;
  if none, get the *first* page in the section.
*/}}
{{- with .PrevInSection -}}
  {{- $vars.Set "next" .Params.homepage -}}
{{- else -}}
  {{- range (first 1 $toroidalPages) -}}
    {{- $vars.Set "next" .Params.homepage -}}
  {{- end -}}
{{- end -}}
{{/*
  Get the list of member pages and create the javascript for selecting a random page.
*/}}
{{- if .Site.Params.Toroidal.RandomMemberLink -}}
  {{- range (first 1 $toroidalPages) -}}
    {{- $vars.Set "memberPages" (slice .Params.homepage) -}}
  {{- end -}}
  {{- range $toroidalPages -}}
    {{- if not (in ($vars.Get "memberPages") .Params.homepage) -}}
      {{- $vars.Set "memberPages" (($vars.Get "memberPages") | append .Params.homepage) -}}
    {{- end -}}
  {{- end -}}
{{- end -}}
<nav aria-labelledby="toroidal-menu-label">
  {{- if .Site.Params.Toroidal.RandomMemberLink -}}
  <script type="text/javascript">
    var memberPages = {{ ($vars.Get "memberPages" | jsonify | safeJS) }};
    function getRandomMemberPage() {
      return memberPages[Math.floor(Math.random() * memberPages.length)];
    };
    function goToRandomMemberPage() {
      window.open(getRandomMemberPage(), "_blank")
    }
  </script>
  {{- end -}}
  <h2 id="toroidal-menu-label">{{ $vars.Get "webringName" }}Webring</h2>
  <ul role="menu" id="toroidal-menu" aria-label="{{ $vars.Get "webringName" }}Webring">
    <li role="none">
      <a role="menuitem" aria-haspopup="false" target="_parent" href="{{ $vars.Get "previous" }}">Previous</a>
    </li>
    <li role="none">
      <a role="menuitem" aria-haspopup="false" target="_parent" href="{{ ref . "/toroidal"}}">Member List</a>
    </li>
    {{- if .Site.Params.Toroidal.RandomMemberLink -}}
    <li role="none">
      <a role="menuitem" aria-haspopup="false" target="_parent" onclick="this.href=getRandomMemberPage()" href="Random Member">Random</a>
    </li>
    {{- end -}}
    <li role="none">
      <a role="menuitem" aria-haspopup="false" target="_parent" href="{{ $vars.Get "next" }}">Next</a>
    </li>
  </ul>
</nav>